<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.comdosoft.financial.manage.mapper.zhangfu.IntentionMapper">
	
	
	
	<resultMap id="BaseResultMap" type="com.comdosoft.financial.manage.domain.zhangfu.task.Intention">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		<id column="id" jdbcType="INTEGER" property="id" />
	</resultMap>

	<sql id="pageWhere">
		<where>
			<if test="status != null"> AND status =#{status} </if>
			<if test="keys != null"> AND intention_name like '%${keys}%' </if>
			<if test="1==1">  AND status  <![CDATA[ <= ]]> 3</if>
		</where>
	</sql>
	<select id="findPageByKeys" resultMap="BaseResultMap">
		SELECT id,intention_name as name,intention_phone as phone,content,status,DATE_FORMAT(created_at,'%Y-%m-%d %H:%i:%s') as date
		from customer_intentions
		<include refid="pageWhere" />
		order by process_user_id = #{id} desc,created_at desc limit #{pageRequest.offset}, #{pageRequest.pageSize}
	</select>

	<select id="countByKeys" resultType="long">
		SELECT count(*) as count FROM customer_intentions 
		<include refid="pageWhere" />
	</select>
	<!-- 分页result end -->

	<select id="findInfo" resultMap="BaseResultMap">
		SELECT
		ci.id,ci.process_user_id,ci.intention_name as name,ci.intention_phone as phone,ci.content,
		c.name as processname,ci.status,DATE_FORMAT(ci.created_at,'%Y-%m-%d %H:%i:%s') as date
		FROM customer_intentions ci
		left join customers c on c.id=ci.process_user_id
		where ci.id=#{id}
	</select>





	
	<resultMap id="ResultInfo3Map" type="com.comdosoft.financial.manage.domain.zhangfu.task.Mark">
	</resultMap>
	<select id="getMark" resultMap="ResultInfo3Map">
<!-- 		SELECT DATE_FORMAT(s.created_at,'%Y-%m-%d %H:%i:%s') created_at,s.content,s.process_user_name as name -->
<!-- 		FROM customer_intentions oa  -->
<!-- 		JOIN customer_intention_marks s ON oa.id=s.intention_id -->
<!-- 		where oa.id=#{id} order by s.created_at desc -->
		SELECT DATE_FORMAT(s.created_at,'%Y-%m-%d %H:%i:%s') created_at,s.content,s.process_user_name as name
		FROM  customer_intention_marks s where s.intention_id =#{id} order by s.created_at desc
	</select>
	
	<insert id="addMark" useGeneratedKeys="true" keyProperty="id">
		insert into customer_intention_marks(intention_id,process_user_id,process_user_name,content,created_at) 
		VALUES(#{applyid},#{cusid},#{name},#{content},NOW())
	</insert>
	
	<update id="upStatus">
		update customer_intentions set status=#{status} where id=#{id}
	</update>
	
	<update id="dispatch">
      update customer_intentions set process_user_id = #{customerId} where id in 
      <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">#{item}</foreach>  
  </update>

</mapper>